<!DOCTYPE html>
<html>
<head>
    <title>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ñ–µ</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</h1>
    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ username }}</p>

    <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á -->
    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6;">
        <h4>üîç –§–∏–ª—å—Ç—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á:</h4>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
            <div>
                <label><strong>–ü–æ –¥–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong></label><br>
                <select id="completedDateFilter" onchange="applyCompletedFilters()">
                    <option value="all">–í—Å–µ</option>
                    <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
                    <option value="yesterday">–í—á–µ—Ä–∞</option>
                    <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
                    <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
                </select>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é -->
            <div>
                <label><strong>–ü–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é:</strong></label><br>
                <select id="completedExecutorFilter" onchange="applyCompletedFilters()">
                    <option value="all">–í—Å–µ</option>
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JS -->
                </select>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É -->
            <div>
                <label><strong>–ü–æ —Ç–∏–ø—É:</strong></label><br>
                <select id="completedTypeFilter" onchange="applyCompletedFilters()">
                    <option value="all">–í—Å–µ</option>
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JS -->
                </select>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º (—Ñ–æ—Ç–æ/–≥—Ä—É–ø–ø–æ–≤—ã–µ) -->
            <div>
                <label><strong>–ü–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º:</strong></label><br>
                <select id="completedSettingsFilter" onchange="applyCompletedFilters()">
                    <option value="all">–í—Å–µ</option>
                    <option value="photo">–° —Ñ–æ—Ç–æ-–æ—Ç—á—ë—Ç–æ–º</option>
                    <option value="group">–ì—Ä—É–ø–ø–æ–≤—ã–µ</option>
                    <option value="simple">–û–±—ã—á–Ω—ã–µ</option>
                </select>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
            <div>
                <br>
                <button onclick="resetCompletedFilters()" style="padding: 5px 10px;">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á -->
    <div style="margin: 10px 0;">
        <button onclick="deleteSelectedCompleted()" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer;">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
        </button>
        <span id="completedSelectedCount" style="margin-left: 10px; color: #666;"></span>
    </div>

    {% if completed_tasks %}
        <table id="completedTasks" border="1" style="border-collapse: collapse; width: 100%;">
            <tr>
                <th>
                    <input type="checkbox" id="selectAllCompleted" onchange="toggleAllCompleted()"> –í—Å–µ
                </th>
                <th>–í—Ä–µ–º—è</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ó–∞–¥–∞—á–∞</th>
                <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                <th>–¢–∏–ø</th>
                <th>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</th>
                <th>–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</th>
                <th>–í—ã–ø–æ–ª–Ω–∏–ª–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            {% for task in completed_tasks %}
            <tr style="background-color: #f8f9fa;">
                <td>
                    <input type="checkbox" class="task-checkbox-completed" value="{{ task[0] }}">
                </td>
                <td>{{ task[1] }}</td>
                <td>
                    {% if task[4] == 1 %}
                        –ü–æ—Å—Ç–æ—è–Ω–Ω–æ
                    {% elif task[6] == 1 %}
                        {{ ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'][task[7]] }}
                    {% elif task[10] == 1 %}
                        {{ task[11] }} —á–∏—Å–ª–æ
                    {% elif task[9] %}
                        {{ task[9] }}
                    {% else %}
                        –°–µ–≥–æ–¥–Ω—è
                    {% endif %}
                </td>
                <td>{{ task[2] }}</td>
                <td>{% if task[8] %}{{ task[8] }}{% else %}–î–ª—è –≤—Å–µ—Ö{% endif %}</td>
                <td>
                    {% if task[4] == 1 %}üîÑ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ
                    {% elif task[6] == 1 %}üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ ({{ ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'][task[7]] }})
                    {% elif task[10] == 1 %}üóìÔ∏è –ï–∂–µ–º–µ—Å—è—á–Ω–æ ({{ task[11] }} —á–∏—Å–ª–æ)
                    {% else %}üìÖ –†–∞–∑–æ–≤–∞—è{% endif %}
                </td>
                <td>
                    {% if task[5] == 1 %}üì∏ –î–∞{% else %}‚Äî{% endif %}
                    {% if task[12] == 1 %}<br>üë• –ì—Ä—É–ø–ø–æ–≤–∞—è{% endif %}
                </td>
                <td>
                    {% if task[13] %}
                        <span style="color: #28a745; font-weight: bold;">{{ task[13] }}</span>
                    {% else %}
                        <span style="color: #dc3545;">–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                    {% endif %}
                </td>
                <td>
                    {% if task[14] %}
                        <small style="color: #666;">{{ task[14] }}</small>
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td>
                    <a href="/restart_task/{{ task[0] }}">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</a> | 
                    <a href="/delete_task/{{ task[0] }}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç</p>
    {% endif %}
    
    <p>
        <a href="/">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–∫—Ç–∏–≤–Ω—ã–º –∑–∞–¥–∞—á–∞–º</a> | 
        <a href="/reports">üìä –û—Ç—á—ë—Ç—ã</a> | 
        <a href="/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a> | 
        <a href="/logout">–í—ã–π—Ç–∏</a>
    </p>

    <script>
        // JavaScript –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
        function populateCompletedFilters() {
            const table = document.getElementById('completedTasks');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
            
            const executors = new Set(['–í—Å–µ']);
            const types = new Set(['–í—Å–µ']);
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 5) {
                    // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (5-—è –∫–æ–ª–æ–Ω–∫–∞)
                    const executor = cells[4].textContent.trim();
                    if (executor && executor !== '–î–ª—è –≤—Å–µ—Ö') {
                        executors.add(executor);
                    } else {
                        executors.add('–î–ª—è –≤—Å–µ—Ö');
                    }
                    
                    // –¢–∏–ø (6-—è –∫–æ–ª–æ–Ω–∫–∞)
                    const type = cells[5].textContent.trim();
                    if (type) {
                        types.add(type);
                    }
                }
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
            const executorSelect = document.getElementById('completedExecutorFilter');
            if (executorSelect) {
                executorSelect.innerHTML = '<option value="all">–í—Å–µ</option>';
                Array.from(executors).sort().forEach(executor => {
                    if (executor !== '–í—Å–µ') {
                        const option = document.createElement('option');
                        option.value = executor;
                        option.textContent = executor;
                        executorSelect.appendChild(option);
                    }
                });
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Ç–∏–ø–æ–≤
            const typeSelect = document.getElementById('completedTypeFilter');
            if (typeSelect) {
                typeSelect.innerHTML = '<option value="all">–í—Å–µ</option>';
                Array.from(types).sort().forEach(type => {
                    if (type !== '–í—Å–µ') {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeSelect.appendChild(option);
                    }
                });
            }
        }

        function applyCompletedFilters() {
            const dateFilter = document.getElementById('completedDateFilter').value;
            const executorFilter = document.getElementById('completedExecutorFilter').value;
            const typeFilter = document.getElementById('completedTypeFilter').value;
            const settingsFilter = document.getElementById('completedSettingsFilter').value;
            
            const table = document.getElementById('completedTasks');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr, tr:not(:first-child)');
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayStr = today.toLocaleDateString('uk-UA');
            const yesterdayStr = yesterday.toLocaleDateString('uk-UA');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                let showRow = true;
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                if (dateFilter !== 'all') {
                    const dateCell = cells[7].textContent.trim();
                    
                    if (dateFilter === 'today' && !dateCell.includes(todayStr)) {
                        showRow = false;
                    } else if (dateFilter === 'yesterday' && !dateCell.includes(yesterdayStr)) {
                        showRow = false;
                    } else if (dateFilter === 'week' || dateFilter === 'month') {
                        if (dateCell === '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                            showRow = false;
                        }
                    }
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é
                if (executorFilter !== 'all' && showRow) {
                    const executorCell = cells[4].textContent.trim();
                    if (executorCell !== executorFilter) {
                        showRow = false;
                    }
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
                if (typeFilter !== 'all' && showRow) {
                    const typeCell = cells[5].textContent.trim();
                    if (typeCell !== typeFilter) {
                        showRow = false;
                    }
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                if (settingsFilter !== 'all' && showRow) {
                    const settingsCell = cells[6].textContent.trim();
                    
                    if (settingsFilter === 'photo' && !settingsCell.includes('üì∏')) {
                        showRow = false;
                    } else if (settingsFilter === 'group' && !settingsCell.includes('üë•')) {
                        showRow = false;
                    } else if (settingsFilter === 'simple' && (settingsCell.includes('üì∏') || settingsCell.includes('üë•'))) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function resetCompletedFilters() {
            document.getElementById('completedDateFilter').value = 'all';
            document.getElementById('completedExecutorFilter').value = 'all';
            document.getElementById('completedTypeFilter').value = 'all';
            document.getElementById('completedSettingsFilter').value = 'all';
            applyCompletedFilters();
        }

        function toggleAllCompleted() {
            const selectAll = document.getElementById('selectAllCompleted');
            const checkboxes = document.querySelectorAll('.task-checkbox-completed');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateCompletedCount();
        }

        function updateCompletedCount() {
            const checkboxes = document.querySelectorAll('.task-checkbox-completed:checked');
            const count = checkboxes.length;
            const countSpan = document.getElementById('completedSelectedCount');
            
            if (count > 0) {
                countSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`;
                countSpan.style.color = '#28a745';
            } else {
                countSpan.textContent = '';
            }
        }

        function deleteSelectedCompleted() {
            const checkboxes = document.querySelectorAll('.task-checkbox-completed:checked');
            const taskIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (taskIds.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${taskIds.length} –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á?`)) {
                fetch('/delete_multiple_tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ task_ids: taskIds, type: 'completed' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞: ' + error);
                });
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            populateCompletedFilters();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox-completed')) {
                    updateCompletedCount();
                }
            });
        });
    </script>
</body>
</html>